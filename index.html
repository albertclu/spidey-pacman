<script>
let score = 0;
let highScore = localStorage.getItem('spideyHighScore') || 0;
let scoreText;
let highScoreText;

const config = {
    type: Phaser.AUTO,
    width: 760, 
    height: 800,
    parent: 'game-container',
    physics: { 
        default: 'arcade', 
        arcade: { gravity: { y: 0 }, debug: false } 
    },
    scene: { preload: preload, create: create, update: update }
};

const mazeLayout = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
    [1,1,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,1,1],
    [0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0],
    [1,1,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,1,1],
    [1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,1,1,1],
    [1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
    [1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],
    [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
    [1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

function preload() {
    this.load.image('spiderman', 'Assets/spiderman.png');
    this.load.image('kingpin', 'Assets/kingpin.png');
    this.load.image('goblin', 'Assets/goblin.png');
    this.load.image('doc-ock', 'Assets/doc-ock.png');
    this.load.image('venom', 'Assets/venom.png');
    this.load.image('wall', 'Assets/wall.png'); 
    this.load.image('web', 'Assets/web.png'); 
}

function create() {
    this.physics.pause(); 
    this.walls = this.physics.add.staticGroup();
    this.webs = this.physics.add.group();

    mazeLayout.forEach((row, y) => {
        row.forEach((cell, x) => {
            let px = x * 40 + 20;
            let py = y * 40 + 20;
            if (cell === 1) {
                this.walls.create(px, py, 'wall').setDisplaySize(40, 40).refreshBody();
            } else {
                let w = this.webs.create(px, py, 'web').setDisplaySize(15, 15);
                w.setTint(0xffffff); 
            }
        });
    });

    // SPAWN SPIDEY: (Row 13, Col 9) is a safe '0' spot
    this.player = this.physics.add.sprite(380, 540, 'spiderman').setDisplaySize(32, 32);
    this.player.setCollideWorldBounds(true);
    // CRITICAL: Shrink the physical hitbox so he can turn corners easily
    this.player.body.setSize(20, 20); 

    this.villains = this.physics.add.group();
    let villainsList = ['kingpin', 'goblin', 'doc-ock', 'venom'];
    villainsList.forEach((key, index) => {
        let v = this.villains.create(100 + (index * 120), 60, key).setDisplaySize(32, 32);
        v.setCollideWorldBounds(true);
        v.body.setSize(20, 20);
        v.setVelocity(120, 0); // Start moving straight
    });

    this.physics.add.collider(this.player, this.walls);
    this.physics.add.collider(this.villains, this.walls, (villain) => {
        // Force cardinal turns only on wall hit
        const dir = Phaser.Math.Between(0, 3);
        const speed = 120;
        if (dir === 0) villain.setVelocity(speed, 0);
        else if (dir === 1) villain.setVelocity(-speed, 0);
        else if (dir === 2) villain.setVelocity(0, speed);
        else if (dir === 3) villain.setVelocity(0, -speed);
    });

    this.physics.add.overlap(this.player, this.webs, collectWeb, null, this);
    this.physics.add.overlap(this.player, this.villains, handleGameOver, null, this);

    scoreText = this.add.text(20, 770, 'Score: 0', { fontSize: '20px', fill: '#fff' });
    highScoreText = this.add.text(550, 770, 'High: ' + highScore, { fontSize: '20px', fill: '#fff' });
}

function update() {
    let cursors = this.input.keyboard.createCursorKeys();
    const speed = 160;
    
    // GRID LOCK MATH: Force Spidey to stay in the middle of the 40px lanes
    let centerX = Math.floor(this.player.x / 40) * 40 + 20;
    let centerY = Math.floor(this.player.y / 40) * 40 + 20;

    // Snapping logic: Only allow movement changes when centered
    if (Phaser.Math.Distance.Between(this.player.x, this.player.y, centerX, centerY) < 4) {
        this.player.x = centerX;
        this.player.y = centerY;
        this.player.setVelocity(0);

        if (cursors.left.isDown) this.player.setVelocityX(-speed);
        else if (cursors.right.isDown) this.player.setVelocityX(speed);
        else if (cursors.up.isDown) this.player.setVelocityY(-speed);
        else if (cursors.down.isDown) this.player.setVelocityY(speed);
    }
}

function collectWeb(player, web) {
    web.disableBody(true, true);
    score += 10;
    scoreText.setText('Score: ' + score);
    if (score > highScore) {
        highScore = score;
        highScoreText.setText('High: ' + highScore);
        localStorage.setItem('spideyHighScore', highScore);
    }
}

function handleGameOver() {
    this.physics.pause();
    document.getElementById('game-over-screen').classList.remove('hidden');
}

function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    game.scene.scenes[0].physics.resume();
}

const game = new Phaser.Game(config);
</script>
